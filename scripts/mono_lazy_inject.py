import frida
import sys
import time
import subprocess
import json


def main():
    session = frida.attach("test.exe")
    script = session.create_script("""
	function hexToBytes(hex) {
		for (var bytes = [], c = 0; c < hex.length; c += 2)
			bytes.push(parseInt(hex.substr(c, 2), 16));
		return bytes;
	}

	
    var baseAddr = Module.findBaseAddress('mono.dll');
    console.log('mono.dll baseAddr: ' + baseAddr);
	
	var  mono_domain_get_func=new NativeFunction(Module.findExportByName("mono.dll" , "mono_domain_get"),"pointer",[],"mscdecl")		
	var  mono_image_open_from_data_func=new NativeFunction(Module.findExportByName("mono.dll" , "mono_image_open_from_data"),"pointer",["pointer","int","int","pointer"],"mscdecl")
	var  mono_assembly_load_from_full_func=new NativeFunction(Module.findExportByName("mono.dll" , "mono_assembly_load_from_full"),"pointer",["int","pointer","pointer","int"],"mscdecl")
	var mono_assembly_get_image_func=new NativeFunction(Module.findExportByName("mono.dll" , "mono_assembly_get_image"),"int",["pointer"])	
	var mono_class_from_name_func=new NativeFunction(Module.findExportByName("mono.dll","mono_class_from_name"),"pointer",["int","pointer","pointer"]);	
	var mono_class_get_method_from_name_func=new NativeFunction(Module.findExportByName("mono.dll","mono_class_get_method_from_name"),"pointer",["pointer","pointer","int"]);
	var mono_runtime_invoke_func=new NativeFunction(Module.findExportByName("mono.dll","mono_runtime_invoke"),"pointer",["pointer","int","int","int"]);
	
	var injected=0;
	function injectDll(){
		console.log('trigger');
		var textDll="4d5a90000300000004000000ffff0000b800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000e1fba0e00b409cd21b8014ccd21546869732070726f6772616d2063616e6e6f742062652072756e20696e20444f53206d6f64652e0d0d0a2400000000000000504500004c010300535b7c580000000000000000e00002210b010b00000e00000006000000000000be2d0000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000642d00005700000000400000d802000000000000000000000000000000000000006000000c0000002c2c00001c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002e74657874000000c40d000000200000000e000000020000000000000000000000000000200000602e72737263000000d8020000004000000004000000100000000000000000000000000000400000402e72656c6f6300000c0000000060000000020000001400000000000000000000000000004000004200000000000000000000000000000000a02d00000000000048000000020005008c220000a0090000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000052168001000004007201000070281000000a00002a000000133001002500000001000011007e010000040b072d1a001780010000047225000070731100000a0a066f0100002b26002a260002281300000a002a0013300500bf0100000200001100027b0300000416fe01130911092d390002027b02000004188d16000001130a110a162200009643281400000aa2110a172200004842281500000aa2110a281600000a7d0200000400168d16000001281700000a00027b0300000416fe01130911093a01010000007241000070178d16000001130a110a16220000c842281400000aa2110a281800000a16fe01130911093ad100000000281900000a0ad019000001281a00000a0b140c00066f1b00000a130b16130c2b31110b110c9a0d00096f1c00000a6f1d00000a7249000070281e00000a16fe01130911092d0500090c2b1500110c1758130c110c110b8e69fe04130911092dc10814fe0116fe01130911092d060038b40000000872690000706f1f00000a1304110472870000706f2000000a1305110514146f2100000a1306110472910000706f2200000a130711071106188d01000001130d110d16168c21000001a2110d17027b02000004a2110d6f2300000a260000027b030000042d0772af0000702b0572b90000700013081108178d16000001130a110a16220000c842281400000aa2110a281800000a16fe01130911092d110002027b0300000416fe017d0300000400282400000a002a6a0272c30000707d0200000402177d0300000402282500000a002a000042534a4201000100000000000c00000076322e302e35303732370000000005006c00000010030000237e00007c030000fc03000023537472696e67730000000078070000c80000002355530040080000100000002347554944000000500800005001000023426c6f620000000000000002000001571402000908000000fa2533001600000100000022000000030000000300000005000000250000000d0000000200000001000000020000000100000000000a0001000000000006003a0033000a004d0041000600a30091000600ba0091000600d70091000600f600910006000f01910006002801910006004301910006005e0191000600960177010600aa0177010600b80191000600d101910006000102ee013f00150200000600440224020600640224020a00850241000a008f0241000a003a0041000a00b90241000a00c90241000600000333000a001c03410006002603330006002b03330006004f03910006006603910006008403330006009f0391000600c10391000600d60333000600dc03910000000000010000000000010001008101000011000000050001000100010010001a00000009000200030011005b000a0001007800150001007f000a00502000000000911864000d00010068200000000096006b000d0001009920000000008100720011000100a4200000000081008500110001006f220000000086188b001100010019008b00180021008b00180029008b00180031008b00180039008b00180041008b00180049008b00180051008b00180059008b001d0061008b00180069008b00180071008b00180079008b00220089008b00280091008b00110099008b022d00a1008b001800a1009a023200a900a7024300b900d3024900b900d9024900b900e0024f00b900e9025700b900f9025e00c1000a036600d1003d036b00c10058037200e10073037800e9007b037d00f1008b038100e10097038700d100ac038d00f900b8039300d100cc039a001101e7039300b900ee030d0011008b0011002e000b00bf002e001300c7002e001b00c7002e002300c7002e002b00bf002e003300cd002e003b00c7002e004b00c7002e005300e5002e0063000f012e006b001c012e00730025012e007b002e013d00a1000480000001000000000000000000000000008202000002000000000000000000000001002a00000000000000000000000000000000000000410000000000250038000000003c4d6f64756c653e0073462e646c6c00496e6a6563746f7200506c7567696e436f6d706f6e656e74006d73636f726c69620053797374656d004f626a65637400556e697479456e67696e65004d6f6e6f4265686176696f757200696e6a6563746564002e6363746f7200496e6a656374004177616b65006c7561537472006d53686f77004f6e475549002e63746f720053797374656d2e5265666c656374696f6e00417373656d626c795469746c6541747472696275746500417373656d626c794465736372697074696f6e41747472696275746500417373656d626c79436f6e66696775726174696f6e41747472696275746500417373656d626c79436f6d70616e7941747472696275746500417373656d626c7950726f6475637441747472696275746500417373656d626c79436f7079726967687441747472696275746500417373656d626c7954726164656d61726b41747472696275746500417373656d626c7943756c747572654174747269627574650053797374656d2e52756e74696d652e496e7465726f70536572766963657300436f6d56697369626c65417474726962757465004775696441747472696275746500417373656d626c7956657273696f6e41747472696275746500417373656d626c7946696c6556657273696f6e4174747269627574650053797374656d2e446961676e6f73746963730044656275676761626c6541747472696275746500446562756767696e674d6f6465730053797374656d2e52756e74696d652e436f6d70696c6572536572766963657300436f6d70696c6174696f6e52656c61786174696f6e734174747269627574650052756e74696d65436f6d7061746962696c697479417474726962757465007346004465627567004c6f670047616d654f626a65637400416464436f6d706f6e656e7400446f6e7444657374726f794f6e4c6f6164004755494c61796f75744f7074696f6e004755494c61796f75740057696474680048656967687400546578744172656100426567696e486f72697a6f6e74616c00427574746f6e00417070446f6d61696e006765745f43757272656e74446f6d61696e00436f6d706f6e656e7400547970650052756e74696d655479706548616e646c65004765745479706546726f6d48616e646c6500417373656d626c7900476574417373656d626c69657300417373656d626c794e616d65004765744e616d65006765745f4e616d6500537472696e67006f705f457175616c69747900476574547970650050726f7065727479496e666f0047657450726f70657274790047657456616c7565004d6574686f64496e666f004765744d6574686f6400496e743332004d6574686f644261736500496e766f6b6500456e64486f72697a6f6e74616c00002373006600200049006e006a006500630074006f007200200053007400610072007400001b50006c007500670069006e004d0061006e0061006700650072000007520075006e00001f41007300730065006d0062006c0079002d00430053006800610072007000011d4c00310030002e0045006e00670069006e0065002e004c0075006100000949006e0073007400001d41006400640043006c00690065006e007400500061007400630068000009530068006f007700000948006900640065000001000000007c1b7b6c888f144b84bd1fa1f844f39f0008b77a5c561934e089020602030000010320000102060e042001010e04200101020520010111410420010108040001011c053001001e00040a01120c05070212510205000101125505000112590c0700020e0e1d1259060001011d1259070002020e1d125904000012610600011269116d0520001d127104200012750320000e050002020e0e05200112690e052001127d0e0620021c1c1d1c0620011280810e1d070e12611269127112711269127d1c1280810e021d12591d1271081d1c070100027346000005010000000017010012436f7079726967687420c2a920203230313600002901002434646234393962352d396336372d343839332d623865362d30613164356534633562623500000c010007312e302e302e3000000801000701000000000801000800000000001e01000100540216577261704e6f6e457863657074696f6e5468726f77730100000000000000535b7c5800000000020000001c010000482c0000480e0000525344531d9136e4867e8b43b959222f6a0fd83d08000000663a5c68616e6875615c70726f6a6563745c73465c73465c6f626a5c44656275675c73462e706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008c2d00000000000000000000ae2d0000002000000000000000000000000000000000000000000000a02d00000000000000000000000000000000000000005f436f72446c6c4d61696e006d73636f7265652e646c6c0000000000ff250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000800200000000000000000000800234000000560053005f00560045005200530049004f004e005f0049004e0046004f0000000000bd04effe00000100000001000000000000000100000000003f000000000000000400000002000000000000000000000000000000440000000100560061007200460069006c00650049006e0066006f00000000002400040000005400720061006e0073006c006100740069006f006e00000000000000b004e0010000010053007400720069006e006700460069006c00650049006e0066006f000000bc0100000100300030003000300030003400620030000000300003000100460069006c0065004400650073006300720069007000740069006f006e00000000007300460000000000300008000100460069006c006500560065007200730069006f006e000000000031002e0030002e0030002e003000000030000700010049006e007400650072006e0061006c004e0061006d0065000000730046002e0064006c006c00000000004800120001004c006500670061006c0043006f007000790072006900670068007400000043006f0070007900720069006700680074002000a90020002000320030003100360000003800070001004f0072006900670069006e0061006c00460069006c0065006e0061006d0065000000730046002e0064006c006c0000000000280003000100500072006f0064007500630074004e0061006d006500000000007300460000000000340008000100500072006f006400750063007400560065007200730069006f006e00000031002e0030002e0030002e003000000038000800010041007300730065006d0062006c0079002000560065007200730069006f006e00000031002e0030002e0030002e00300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000c000000c03d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
		var bytes=hexToBytes(textDll)
		var mem=Memory.alloc(bytes.length)
		Memory.writeByteArray(mem, bytes)
		console.log(Memory.readByteArray(mem,128))
		
		var status=Memory.alloc(4)
		console.log("status "+status)
		var domain_result=mono_domain_get_func();

		var image_data_get_result=mono_image_open_from_data_func(mem,bytes.length,0,status);
		console.log("image_data_get_result "+image_data_get_result)
		console.log("status "+Memory.readInt(status));

		//raw_data的指针指向的值
		var address=Memory.readInt(ptr(image_data_get_result.toInt32()+8));
		console.log("raw_data address:"+address);
		//console.log("val:"+Memory.readInt(ptr(address)));
		//raw_data的偏移应该是8
		console.log(Memory.readByteArray(ptr(address),128))
		//raw_data_len的偏移为12
		console.log("raw_data_len "+Memory.readInt(ptr(image_data_get_result.toInt32()+12)))   
		
		var image=new NativePointer(image_data_get_result);
		
		var status2=Memory.alloc(4)

		var pName=Memory.allocUtf8String("ok")
		console.log("mono_assembly_load_from_full_func "+mono_assembly_load_from_full_func)
		var assembly=mono_assembly_load_from_full_func(image_data_get_result.toInt32(),pName,status2,0)
		console.log("status "+Memory.readInt(status));
		console.log("assembly "+assembly);
		
		var ret3=mono_assembly_get_image_func(assembly)
		console.log("ret3:"+ret3);
		var klass=mono_class_from_name_func(ret3,Memory.allocUtf8String(""),Memory.allocUtf8String("Injector"));
		console.log("klass:"+klass);
		var method=mono_class_get_method_from_name_func(klass,Memory.allocUtf8String("Inject"),0)
		console.log("method "+method);	
		var obj=mono_runtime_invoke_func(method,0,0,0)
		console.log("obj "+obj);	
	}
	Interceptor.attach(Module.findExportByName("mono.dll" , "mono_gc_collect"), {
        onEnter: function(args) {
			console.log('mono_gc_collect onEnter');
		},
		onLeave:function(retval){
			if(injected==0){
				injected=1;
				injectDll();
			}
		}
    });

""")

    script.on('message', on_message)
    script.load()
    fileContent=open('F:\\GitHub\\frida_learning\\scripts\\sF.dll', 'rb').read()
    byteStr=''.join('{:02x}'.format(x) for x in fileContent)
	#写dll的方法
    #textFile=open("textsF.txt","w")
    #textFile.write(byteStr)
    #textFile.close();
    time.sleep(1)
    
    script.post({"type": "post","data":byteStr})
    input('[!] Press Enter at any time to detach from instrumented program.\n\n')
    session.detach()
def on_message(message, data):
   print("recv [%s] => %s" % (message, data))
	  
if __name__ == '__main__':
    main()
